---
title: 02. 协调与同步
---
## 分布式互斥

在分布式系统里，排他性的资源访问方式，叫作**分布式互斥**（Distributed Mutual Exclusion），
而这种被互斥访问的共享资源就叫**作临界资源**（Critical Resource）

### 集中式算法
协调者参与

{{< mermaid >}}
graph TB

subgraph 分布式系统
A[程序 A] --> C[协调者]
B[程序 B] --> C[协调者]
end

subgraph 互斥算法
C[协调者] --> D[发送请求]
D --> E[检查资源状态]
E --> |资源空闲| F[授权访问]
E --> |资源占用| G[排号等待]
G --> H[接收通知]
H --> D
F --> I[访问资源]
I --> J[释放资源]
J --> |通知协调者| C
end
{{< /mermaid >}}

优点
- 开发和实现简单,不存在节点间的协调问题
- 数据一致性易于控制
- 故障修复相对简单

缺点
- 可靠性和性能依赖于中心节点
- 中心节点出故障或压力过大会导致整体服务挂掉
- 难以水平扩展以提升吞吐量

### 分布式算法
定义
> 当一个程序要访问临界资源时，先向系统中的其他程序发送一条请求消息，在接收到所有程序返回的同意消息后，才可以访问临界资源。其中，请求消息需要包含所请求的资源、请求者的 ID，以及发起请求的时间

{{< mermaid >}}
sequenceDiagram
actor 程序1
actor 程序2
actor 程序3

程序1->>程序2: 请求访问资源A
程序1->>程序3: 请求访问资源A
程序2-->>程序1: 同意
程序3-->>程序1: 同意

程序3->>程序1: 请求访问资源A
程序3->>程序2: 请求访问资源A
程序2-->>程序3: 同意
Note over 程序3: 等待程序1使用完
程序1-->>程序3: 同意

程序1->>资源A: 使用资源A
程序1-->>资源A: 释放资源A

程序3->>资源A: 使用资源A
程序3-->>资源A: 释放资源A
{{< /mermaid >}}

在大型系统中使用分布式算法，消息数量会随着需要访问临界资源的程序数量呈指数级增加，容易导致高昂的"**沟通成本**"。


分布式算法适合**节点数目少**且**变动不频繁**的系统，且由于每个程序均需通信交互，因此适合 P2P 结构的系统.


#### Hadoop

HDFS 的文件修改
{{< mermaid >}}

sequenceDiagram
participant 计算机 1
participant 计算机 2
participant 计算机 3
计算机 1 ->> 计算机 2: 发送文件修改请求
计算机 1 ->> 计算机 3: 发送文件修改请求
计算机 2 -->> 计算机 1: 同意请求
计算机 3 -->> 计算机 1: 同意请求
计算机 1 ->> D文件: 开始修改文件
D文件 -->> 计算机 1: 修改完成
计算机 1 ->> 计算机 2: 发送修改完成消息和文件数据
计算机 1 ->> 计算机 3: 发送修改完成消息和文件数据
计算机 2 ->> E文件: 接收文件数据
计算机 3 ->> F文件: 接收文件数据

{{< /mermaid >}}

分布式算法是一个“先到先得"和“投票全票通过"的公平访问机制，但通信成本较高，可用性也比集中式算法低，适用于临界资源使用频度较低，且系统规模较小的场景.

### 令牌环算法
{{< mermaid >}}
graph TD
A -- 拥有临牌时访问 --> 资源
B -- 拥有临牌时访问 --> 资源
C -- 拥有临牌时访问 --> 资源 
D -- 拥有临牌时访问 --> 资源

A -. 传递令牌 .-> B
B -. 传递令牌 .-> C
C -. 传递令牌 .-> D
D -. 传递令牌 .-> A
{{< /mermaid >}}
令牌环算法的公平性高，在改进单点故障后，稳定性也很高，适用于系统规模较小，并且系统中每个程序使用临界资源的**频率高且使用时间比较短**的场景.